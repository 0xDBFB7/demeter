<!DOCTYPE HTMP PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title>File type plugins</title>
    <link rel="stylesheet" href=../ab.css />
    <link rel="stylesheet" href=../ppi.css />
    <meta http-equiv="Content-Type" content="text/html"; charset=iso-8859-15 />
    <meta name="robots" contents="all" />
  </head>

  <body>
    <div class=topbar>
  <div class=navbar>
  <a class=navhead href="../index.html">The Athena Users' Guide</a>
  <table class=navtable>
    <tr>
      <td align=left>
        &laquo;<a class=navtable href="http://bruceravel.github.com/demeter/"><span class=programlink>DEMETER</span></a>&raquo; &nbsp;
        &laquo;<a class=navtable href="http://cars9.uchicago.edu/iffwiki/Ifeffit"><span class=programlink>IFEFFIT</span></a>&raquo; &nbsp;
        <!-- [&nbsp;<a class=navtable href="http://leonardo.phys.washington.edu/feff/wiki/index.php?title=FEFF_Documentation"></a>&nbsp;] &nbsp; -->
        &laquo;<a class=navtable href="http://xafs.org">xafs.org</a>&raquo; &nbsp;
	<!-- [&nbsp;<a class=navtable href="../demeter.pdf">PDF&nbsp;doc</a>&nbsp;] -->
      </td>
      <td align=right>
        Back: <a class=navtable href="../other/journal.html" class="menu">Project journal</a> &nbsp;&nbsp;
        &nbsp;&nbsp;
        Up: <a class=navtable href="../other/index.html" class="menu">Other main window chores</a> &nbsp;&nbsp;
        Next: <a class=navtable href="../other/prefs.html" class="menu">Setting preferences</a>      </td>
    </tr>
  </table>
  </div>
</div>

<div class=sidebar>
  <a href="../pallas.html"><img src=../../images/pallas_athene_thumb.jpg
    width=90% border=0 alt='[Athena logo]'></a>
  <br />
  <a href="../index.html"  class="menu">Home</a><br />
<a href="../forward.html"  class="menu">Forward</a><br />
<a href="../intro.html"  class="menu">Introduction</a><br />
<a href="../import/index.html"  class="menu">Importing Data</a><br />
<a href="../bkg/index.html"  class="menu">Background Removal</a><br />
<a href="../plot/index.html"  class="menu">Plotting</a><br />
<a href="../ui/index.html"  class="menu">User Interface</a><br />
<a href="../params/index.html"  class="menu">Setting parameter values</a><br />
<a href="../output/index.html"  class="menu">Output files</a><br />
<a href="../process/index.html"  class="menu">Data processing</a><br />
<a href="../analysis/index.html"  class="menu">Data analysis</a><br />
<a href="../other/index.html"  class="menuselect">Other main window chores</a><br />
&nbsp;&#8618;&nbsp;<a href="../other/meta.html"  class="menu">File metadata</a><br />
&nbsp;&#8618;&nbsp;<a href="../other/journal.html"  class="menu">Project journal</a><br />
&nbsp;&#8618;&nbsp;<span style="font-style: italic;">Filetype plugins</span><br />
&nbsp;&#8618;&nbsp;<a href="../other/prefs.html"  class="menu">Setting preferences</a><br /><a href="../examples/index.html"  class="menu">Worked examples</a><br />
</div>

<div class=contentarea>


<h1>
  <img src="../../images/bend.png" width="300" height="295" alt="" align="center" />  File type plugins
</h1>
<h2>
  Extending Athena to read new file types 
</h2>

<p class=todo>
<img class=tinyfloatleft border=0 src="../../images/todo.png" alt="To do!">
Move this page to the appropriate chapter.  Also resolve issues
surrounding user and system plugins .. do user plugins really exist?
</p>


<p>

<span class=program>ATHENA</span> uses <span class=program>IFEFFIT</span>'s
<a href="http://cars9.uchicago.edu/~ifeffit/refman/node99.html">read_data()</a>
function to import data. This means
that <span class=program>ATHENA</span>'s notion of what is an acceptable data format is
completely identical to <span class=program>IFEFFIT</span>'s notion. The contrapositive is also
true -- if <span class=program>IFEFFIT</span> can read a data file, so can <span class=program>ATHENA</span>.
</p>

<p>
In practice, this works great. <span class=program>IFEFFIT</span> is able to read the data files
generated by many of the world's XAS beamlines. And so, consequently,
is <span class=program>ATHENA</span>. Sadly, there are many beamlines that use a format that
confounds <span class=program>IFEFFIT</span> and <span class=program>ATHENA</span>. There are two obvious ways that I
could deal with data from those beamline:
</p>


<ol>
  
<li><p>
Refuse to deal with them and require the user to transform the
data into a form that <span class=program>IFEFFIT</span> can handle.
</p></li>
<li><p>
Hard-wire code into <span class=program>ATHENA</span> to deal with each new data format as I
become aware of it.
</p></li>
</ol>

<p>

Neither of those are particularly user-friendly.  <span class=program>ATHENA</span> instead
relies on a plugin architecture allowing <span class=program>ATHENA</span> to be extended on
the fly to deal well with new data formats without having to change the
underlying code.
</p>

<p>
This page documents the plugin architecture so that <span class=program>ATHENA</span>'s
users can write their own file type plugins. 
</p>


<hr class=hide />
<a name="overviewofhowpluginswork">

<h2>  Overview of how plugins work</h2>
</a>
<p>

In simple language, a perl module is a short file containing special
perl code placed in a special location. <span class=program>ATHENA</span> uses the code
contained in that file to recognize and pre-process data files so that
they can be imported properly using <span class=program>IFEFFIT</span>.
</p>

<p>
In somewhat more technical language, a plugin is just
<a href="http://perldoc.perl.org/perlmod.html">a perl module</a>
placed on your computer in a place where it can be found.
This file is used when <span class=program>ATHENA</span> starts and its methods are available
when data are imported.
</p>

<p>
When a plugin is available for use, it is invoked every time a file is
imported into <span class=program>ATHENA</span> using the Open file function. The new file
is checked using one of the plugin's methods to ascertain if the file
is of the sort serviced by the plugin. If the file is recognized,
another method in the plugin transforms the original data file into a
form that is readable by <span class=program>IFEFFIT</span>. This transformation is done in a way
that leaves the original data file unchanged.
</p>

<p>
If the transformation is successful, the user is presented with
<span class=program>ATHENA</span>'s column selection dialog and can import data in the normal
manner. Ideally, a plugin is written in a way that makes the import of
the data into <span class=program>ATHENA</span> a completely transparent process for the user.
</p>



<hr class=hide />
<a name="exampleplugin">

<h2>  Example plugin</h2>
</a>
<p>

Here is a complete example of a functional plugin taken from the
<span class=program>HORAE</span> distribution.  This plugin allows <span class=program>ATHENA</span> to import
files from NSLS beamline X10C.  As you can see, the plugin is quite
short. The following sections of this page will explain this example
in detail.
</p>



<pre class=olscript>
<ol class=perlblock>
<li><span class="keyword">package</span> <span class="word">Demeter::Plugins::X10C</span><span class="structure">;</span>
<li>
<li><span class="keyword">use</span> <span class="word">Moose</span><span class="structure">;</span>
<li><span class="word">extends</span> <span class="single">'Demeter::Plugins::FileType'</span><span class="structure">;</span>
<li>
<li><span class="word">has</span> <span class="single">'+is_binary'</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">=&gt;</span> <span class="structure">(</span><span class="word">default</span> <span class="operator">=&gt;</span> <span class="number">0</span><span class="structure">);</span>
<li><span class="word">has</span> <span class="single">'+description'</span>&nbsp;&nbsp;<span class="operator">=&gt;</span> <span class="structure">(</span><span class="word">default</span> <span class="operator">=&gt;</span> <span class="double">&quot;NSLS beamline X10C&quot;</span><span class="structure">);</span>
<li><span class="word">has</span> <span class="single">'+version'</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">=&gt;</span> <span class="structure">(</span><span class="word">default</span> <span class="operator">=&gt;</span> <span class="float">0.1</span><span class="structure">);</span>
<li><span class="word">has</span> <span class="single">'+metadata_ini'</span> <span class="operator">=&gt;</span> <span class="structure">(</span><span class="word">default</span> <span class="operator">=&gt;</span> <span class="word">File::Spec</span><span class="operator">-&gt;</span><span class="word">catfile</span><span class="structure">(</span><span class="word">File::Basename::dirname</span><span class="structure">(</span><span class="symbol">$INC</span><span class="cast">\</span><span class="structure">{</span><span class="single">'Demeter.pm'</span><span class="cast">\</span><span class="structure">})</span><span class="operator">,</span>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'Demeter'</span><span class="operator">,</span> <span class="single">'share'</span><span class="operator">,</span> <span class="single">'xdi'</span><span class="operator">,</span> <span class="single">'x10c.ini'</span><span class="structure">));</span>
<li>
<li><span class="keyword">sub</span> <span class="word">is</span> <span class="structure">{</span>
<li>&nbsp;&nbsp;<span class="keyword">my</span> <span class="structure">(</span><span class="symbol">$self</span><span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span>
<li>&nbsp;&nbsp;<span class="word">open</span> <span class="word">D</span><span class="operator">,</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">file</span> <span class="operator">or</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">Croak</span><span class="structure">(</span><span class="double">&quot;could not open &quot;</span> <span class="operator">.</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">file</span> <span class="operator">.</span> <span class="double">&quot; as data (X10C)\n&quot;</span><span class="structure">);</span>
<li>&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$first</span> <span class="operator">=</span> <span class="readline">&lt;D&gt;</span><span class="structure">;</span>
<li>&nbsp;&nbsp;<span class="word">close</span> <span class="word">D</span><span class="operator">,</span> <span class="keyword">return</span> <span class="number">0</span> <span class="word">unless</span> <span class="structure">(</span><span class="word">uc</span><span class="structure">(</span><span class="symbol">$first</span><span class="structure">)</span> <span class="operator">=~</span> <span class="match">/^EXAFS/</span><span class="structure">);</span>
<li>&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$lines</span> <span class="operator">=</span> <span class="number">0</span><span class="structure">;</span>
<li>&nbsp;&nbsp;<span class="keyword">while</span> <span class="structure">(</span><span class="readline">&lt;D&gt;</span><span class="structure">)</span> <span class="structure">{</span>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">close</span> <span class="word">D</span><span class="operator">,</span> <span class="keyword">return</span> <span class="number">1</span> <span class="word">if</span> <span class="structure">(</span><span class="word">uc</span><span class="structure">(</span><span class="symbol">$first</span><span class="structure">)</span> <span class="operator">=~</span> <span class="match">/^\s+DATA START/</span><span class="structure">);</span>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">++</span><span class="symbol">$lines</span><span class="structure">;</span>
<li>&nbsp;&nbsp;<span class="structure">};</span>
<li>&nbsp;&nbsp;<span class="word">close</span> <span class="word">D</span><span class="structure">;</span>
<li><span class="structure">};</span>
<li>
<li>
<li><span class="keyword">sub</span> <span class="word">fix</span> <span class="structure">{</span>
<li>&nbsp;&nbsp;<span class="keyword">my</span> <span class="structure">(</span><span class="symbol">$self</span><span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span>
<li>&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$new</span> <span class="operator">=</span> <span class="word">File::Spec</span><span class="operator">-&gt;</span><span class="word">catfile</span><span class="structure">(</span><span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">stash_folder</span><span class="operator">,</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">filename</span><span class="structure">);</span>
<li>&nbsp;&nbsp;<span class="structure">(</span><span class="symbol">$new</span> <span class="operator">=</span> <span class="word">File::Spec</span><span class="operator">-&gt;</span><span class="word">catfile</span><span class="structure">(</span><span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">stash_folder</span><span class="operator">,</span> <span class="double">&quot;toss&quot;</span><span class="structure">))</span> <span class="word">if</span> <span class="structure">(</span><span class="word">length</span><span class="structure">(</span><span class="symbol">$new</span><span class="structure">)</span> <span class="operator">&gt;</span> <span class="number">127</span><span class="structure">);</span>
<li>&nbsp;&nbsp;<span class="word">open</span> <span class="word">D</span><span class="operator">,</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">file</span> <span class="operator">or</span> <span class="word">die</span> <span class="double">&quot;could not open &quot;</span> <span class="operator">,</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">file</span> <span class="operator">.</span> <span class="double">&quot; as data (fix in X10C)\n&quot;</span><span class="structure">;</span>
<li>&nbsp;&nbsp;<span class="word">open</span> <span class="word">N</span><span class="operator">,</span> <span class="double">&quot;&gt;&quot;</span><span class="operator">.</span><span class="symbol">$new</span> <span class="operator">or</span> <span class="word">die</span> <span class="double">&quot;could not write to $new (fix in X10C)\n&quot;</span><span class="structure">;</span>
<li>&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$header</span> <span class="operator">=</span> <span class="number">1</span><span class="structure">;</span>
<li>&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$null</span> <span class="operator">=</span> <span class="word">chr</span><span class="structure">(</span><span class="number">0</span><span class="structure">)</span><span class="operator">.</span><span class="single">'+'</span><span class="structure">;</span>
<li>&nbsp;&nbsp;<span class="keyword">while</span> <span class="structure">(</span><span class="readline">&lt;D&gt;</span><span class="structure">)</span> <span class="structure">{</span>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="magic">$_</span> <span class="operator">=~</span> <span class="substitute">s/$null//g</span><span class="structure">;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment"># clean up nulls</span>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">print</span> <span class="word">N</span> <span class="double">&quot;# &quot;</span> <span class="operator">.</span> <span class="magic">$_</span> <span class="word">if</span> <span class="symbol">$header</span><span class="structure">;</span> <span class="comment"># comment headers</span>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">(</span><span class="symbol">$header</span> <span class="operator">=</span> <span class="number">0</span><span class="structure">)</span><span class="operator">,</span> <span class="word">next</span> <span class="word">if</span> <span class="structure">(</span><span class="word">uc</span><span class="structure">(</span><span class="magic">$_</span><span class="structure">)</span> <span class="operator">=~</span> <span class="match">/^\s+DATA START/</span><span class="structure">);</span>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">next</span> <span class="word">if</span> <span class="structure">(</span><span class="symbol">$header</span><span class="structure">);</span>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="magic">$_</span> <span class="operator">=~</span> <span class="substitute">s/([eE][-+]\d{1,2})-/$1 -/g</span><span class="structure">;</span> <span class="comment"># clean up 5th column</span>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">print</span> <span class="word">N</span> <span class="magic">$_</span><span class="structure">;</span>
<li>&nbsp;&nbsp;<span class="structure">};</span>
<li>&nbsp;&nbsp;<span class="word">close</span> <span class="word">N</span><span class="structure">;</span>
<li>&nbsp;&nbsp;<span class="word">close</span> <span class="word">D</span><span class="structure">;</span>
<li>&nbsp;&nbsp;<span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">fixed</span><span class="structure">(</span><span class="symbol">$new</span><span class="structure">);</span>
<li>&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$new</span><span class="structure">;</span>
<li><span class="structure">}</span>
<li>
<li><span class="keyword">sub</span> <span class="word">suggest</span> <span class="structure">{</span>
<li>&nbsp;&nbsp;<span class="keyword">my</span> <span class="structure">(</span><span class="symbol">$self</span><span class="operator">,</span> <span class="symbol">$which</span><span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span>
<li>&nbsp;&nbsp;<span class="symbol">$which</span> <span class="operator">||=</span> <span class="single">'transmission'</span><span class="structure">;</span>
<li>&nbsp;&nbsp;<span class="keyword">if</span> <span class="structure">(</span><span class="symbol">$which</span> <span class="operator">eq</span> <span class="single">'transmission'</span><span class="structure">)</span> <span class="structure">{</span>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="structure">(</span><span class="word">energy</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">=&gt;</span> <span class="single">'$1'</span><span class="operator">,</span>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">numerator</span>&nbsp;&nbsp;&nbsp;<span class="operator">=&gt;</span> <span class="single">'$4'</span><span class="operator">,</span>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">denominator</span> <span class="operator">=&gt;</span> <span class="single">'$6'</span><span class="operator">,</span>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">ln</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">=&gt;</span>&nbsp;&nbsp;<span class="number">1</span><span class="operator">,</span><span class="structure">);</span>
<li>&nbsp;&nbsp;<span class="structure">}</span> <span class="keyword">else</span> <span class="structure">{</span>
<li>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="structure">();</span>
<li>&nbsp;&nbsp;<span class="structure">};</span>
<li><span class="structure">};</span>
<li>
<li>
<li><span class="word">__PACKAGE__</span><span class="operator">-&gt;</span><span class="word">meta</span><span class="operator">-&gt;</span><span class="word">make_immutable</span><span class="structure">;</span>
<li><span class="number">1</span><span class="structure">;</span>
<li>
</ol>
</pre>



<hr class=hide />
<a name="namespace">

<h2>  Namespace</h2>
</a>
<p>

The module must be in a particular namespace. The namespace is defined
by the package function on line 1 of the example.  The package must be below the
<tt>Demeter::Plugins</tt>
namespace and should have a name that is descriptive of what format it
is made for.  In the case of the example, the plugin is intended to
transform files from NSLS beamline X10C, so the full namespace of the module is
<tt>Demeter::Plugins::X10C</tt>.
Lines 3, 4, 62, and 63 are some requisite boilerplate which allow this module
to work properly with <span class=program>DEMETER</span> and <span class=program>ATHENA</span>.
</p>


<hr class=hide />
<a name="requiredmethodsandvariables">

<h2>  Required methods and variables</h2>
</a>
<p>

The plugin must supply three
methods and must set several attributes of the Plugin object.
</p>


<hr class=hide />
<a name="requiredattributes">

<h3>  required attributes</h3>
</a>
<p>

Lines 12-14 define the two required variables in a way that allows
them to be accessed outside the scope of this module.
</p>


<dl>
  
<dt>
  is_binary
</dt>
<dd>
(Line 6) A boolean that tells <span class=program>ATHENA</span> whether the input file format
is in a text or binary format.  <span class=program>ATHENA</span> handles binary files slightly
differently in the column selection dialog.
  <br />
  <br />
</dd>
<dt>
  description
</dt>
<dd>
(Line 7) A short text string describing the purpose of this plugin. This
string will be displayed in the plugin registry.  This description
should be no more than a few dozen characters.
  <br />
  <br />
</dd>
<dt>
  version
</dt>
<dd>
(Line 8) This is a numeric version of the plugin.
  <br />
  <br />
</dd>
<dt>
  metadata_ini
</dt>
<dd>
<p class=todo>
<img class=tinyfloatleft border=0 src="../../images/todo.png" alt="To do!">
(Line 9) Document this attribute once the meta data system is fleshed out
</p>
  <br />
  <br />
</dd>
</dl>

<hr class=hide />
<a name="theismethod">

<h3>  the is method</h3>
</a>
<p>

Lines 12-23 show the <tt>is</tt>
method. This method is called by <span class=program>ATHENA</span>
to try to recognize an input data file as being of a particular
format. In the case of this example, the X10C file is recognized by
some of the text in the first few lines of the files.  When the file is
recognized, this method returns a true value.  If the test fails, it
returns 0.  When <span class=program>ATHENA</span> sees the true return value, it applies
the fix method to transform the data file into an <span class=program>IFEFFIT</span>-friendly
format.
</p>

<p>
It is quite important that the is method be fast. It is possible that
a data file will have to be tested against a large number of
plugins.  If the is method is slow, file import will be slow.
</p>


<hr class=hide />
<a name="thefixmethod">

<h3>  the fix method</h3>
</a>
<p>

Lines 26-46 show the <tt>fix</tt>
method.  This method is called when the is
method returns true.  In some manner it makes a copy of the original
data file and transforms that copy into a form that can be read by
<span class=program>IFEFFIT</span>.  This method needs to follow a number of strict rules,
however within those rules there is a lot of flexibility about how the
transformation is accomplished and the scope of what that
transformation does to the data.
</p>

<p>
First and most important, never alter the original data!  Either work
on the contaents of the original file in memory or make a copy of the
data, preferably in the stash folder (a folder known to <span class=program>DEMETER</span> as
a place for writing scratch files).  At line 29, we see that file is
opened in the stash folder for holding the transformed data.  As t he
data is processed, the output is written to that file (see lines 36
and 40).
</p>

<p>
Do whatever chore needs doing to transform the portion of the
original data file that needs attention.  Afterwords close both the
input and output files.  It is esential that the files be closed,
particularly on Windows, which locks opened files from other uses.
</p>

<p>
Finally set the <tt>fixed</tt> attribute of the
object to the path and name of the transformed file and return that
same string.
</p>

<p>
In the example given on this page, the first thing the
<tt>fix</tt> method does
is to create a file name in the stash directory for the transformed
file. Line 28 tells <span class=program>ATHENA</span> to give the stash file the same name
as the original file (before calling this method,  <span class=program>ATHENA</span> sets the
<tt>filename</tt> attribute appropriately)
but in the stash directory (the catfile method builds a fully resolved
filename in a platform transparent manner).  Line 29 checks the length
of the fully resolved filename to avoid running into one of <span class=program>IFEFFIT</span>'s
internal limitations.
</p>

<p>
Three things are done to transform an X10C file. The header is
stripped of null characters, the header is commented out by putting
# characters in the first column, and a
formatting problem in some files involving a lack of white space
between columns is resolved.  Each line of the original file is read,
operated on, and written to the transformed file in the stash
directory. The while loop starting at line 34 reads through the file
line-by-line and performs the operations.
</p>

<p>
Lines 42 and 43 close the original and new file handles. The filter
should always close the file handles.  This is not such a huge issue
under unix, but Windows places a lock on any open file handle.  If you
fail to close one, for as long as <span class=program>ATHENA</span> is running no other process
will be able to do anything with that file.
</p>

<p>
At line 45, the method returns with the fully resolved name of the
transformed file. At no point was the original file altered. When
<span class=program>ATHENA</span> exits, it will clean up the stash directory, thus avoiding a
pile up of unnecessary data files.
</p>

<p>
<span class=program>DEMETER</span> ships with a number of differnt kinds of plugins.  Some of
them perform simple, linear transofrmations (like this one).  Others
interpret binary data.  A couple export project files rather than data
files.  One even performs an on-the-fly deadtime correction for data
from an energy dispersive detector.  Examine them for hints about how
to create your own plugins.
</p>


<hr class=hide />
<a name="thesuggestmethod">

<h3>  the suggest method</h3>
</a>
<p>

Lines 48-59 show the <tt>suggest</tt>
method.  This provides feedback for use by the 
<a href="../import/columns.html">column selection dialog</a>
is selecting initial guesses for the columns containing the numerator
and denominator of the data.  In this case, the method suggests
columns for transmission data butmakes no suggestions of fluorescence
data. 
</p>







<hr class=hide />
<a name="athena'spluginregistry">

<h2>  Athena's plugin registry</h2>
</a>
<p>

</p>

<p>
Because there might be a large number of file type plugins, it is
possible for the user to turn the checks for the file types on and
off. In the Settings menu, you will find the Plugin Registry.  This is
a simple list of all plugins found in the system and user directories.
The check buttons enable and disable the plugins. The value of the
<tt></tt> variable is displayed in the
list (so be sure to choose a suitable and suitably short value for
that variable).
</p>


<div class=figure style="max-width: 764px; min-width: 7em;">
<a name=import_plugin>
<img src=../../images/import_plugin.png width=100%>
</a>
<p align=center>
<span class=program>ATHENA</span>'s plugin registry.
</p>
</div>

<p>

Note that the order in which the plugins are displayed
above
is the same order in which files are checked against the plugins. User
plugins are checked before system plugins.  After that the plugins are
ordered alphabetically. If you want your system plugins to be checked
against the data first, choose a name that comes early in the
alphabetical sense.
</p>

<p>
Right-clicking on an item in the registry posts the context menu shown
in the figure above.  All such context menus have at least one item
for reading the documentation contained in the plugin source code
file.  Some plugins, such as the one shown, also provide a way of
configuring the behavior of the plugin.
</p>



<hr class=hide />
<a name="systempluginsanduserplugins">

<h2>  System plugins and user plugins</h2>
</a>
<p>

</p>

<p>
<span class=program>ATHENA</span> looks in two different places for these plugins. One place is
in <span class=program>ATHENA</span>'s installation location where it finds the plugins that come
with the horae distribution. The other is in the user's space
(on Windows plugins are located in
<span class=file>C:\Program
File\Ifeffit\horae\Ifeffit\Plugins\Filetype\Athena\</span>,
on unix <span class=file>$HOME/.horae/Ifeffit/Plugins/Filetype/Athena/</span>).
In both places, it reads the contents of the plugin directory and
attempts to import the files which end in
<span class=file>.pm</span>.</p>


<hr class=hide />
<a name="miscellaneousadviceonplugins">

<h2>  Miscellaneous advice on plugins</h2>
</a>
<ol>
  
<li><p>
Cut-n-paste is an excellent way to get started on a new
plugin. Make a copy of a plugin for a file that is similar to
your own file and use that as the basis for your new plugin.
</p></li>
<li><p>
<span class=file>X15B.pm</span> is an example of a plugin
for a binary format.
</p></li>
<li><p>
You can use any module that you need, thus you have all of CPAN
available to you when designing your plugin. If you need to do
any seriously heavy lifting, check out the
<tt>Math::Pari</tt> module or
the <a href="http://pdl.perl.org">Perl Data Language</a>
</p></li>
<li><p>
Although a well-tested, robust plugin should be your goal, one of
the nice features of the plugin architecture is that a
&ldquo;good-enough&rdquo; plugin is easy to write
and can quickly get you over a hurdle.
</p></li>
</ol>

</div>

<br />
<hr class=hide />
<hr class=bottomdivider />

<div class=bottombar>
  <div class=copyright>
  <table>
    <tr>
      <td colspan=2>
        <span class=program>DEMETER</span> is copyright &copy; 2009-2013 Bruce Ravel
        &mdash;
        This document is copyright &copy; 2013 Bruce Ravel
        <br />
      </td>
    </tr>
    <tr valign=middle>
      <td> 
           <a href="http://creativecommons.org/licenses/by-sa/3.0/"><img src="../../images/somerights20.png" width="88" height="31" alt="" border="0" /></a> &nbsp;&nbsp;&nbsp;
      </td>
      <td>
  	This document is licensed under <a href="http://creativecommons.org/licenses/by-sa/3.0/">
  	The Creative Commons Attribution-ShareAlike License</a>.
  	<br />
  	If <span class=program>DEMETER</span> and this document are useful to you, please consider
  	<a href="http://creativecommons.org/support/">supporting The Creative Commons</a>.
      </td>
    </tr>
  </table>
</div>
</div>
  </body>
</html>