<!DOCTYPE HTMP PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title>Histogram</title>
    <link rel="stylesheet" href=../dpg.css />
    <link rel="stylesheet" href=../ppi.css />
    <meta http-equiv="Content-Type" content="text/html"; charset=iso-8859-15 />
    <meta name="robots" contents="all" />
  </head>

  <body>
    <div class=topbar>
  <div class=navbar>
  <a class=navhead href="../index.html">The Demeter Programmer' Guide</a>
  <table class=navtable>
    <tr>
      <td align=left>
        &laquo;<a class=navtable href="http://bruceravel.github.io/demeter/"><span class=programlink>DEMETER</span></a>&raquo; &nbsp;
        &laquo;<a class=navtable href="http://cars9.uchicago.edu/iffwiki/Ifeffit"><span class=programlink>IFEFFIT</span></a>&raquo; &nbsp;
        <!-- [&nbsp;<a class=navtable href="http://leonardo.phys.washington.edu/feff/wiki/index.php?title=FEFF_Documentation"><span class=programlink>FEFF</span></a>&nbsp;] &nbsp; -->
        &laquo;<a class=navtable href="http://xafs.org">xafs.org</a>&raquo; &nbsp;
	<!-- [&nbsp;<a class=navtable href="../demeter.pdf">PDF&nbsp;doc</a>&nbsp;] -->
      </td>
      <td align=right>
        Back: <a class=navtable href="../examples/uranyl.html" class="menu">Uranyl complex in solution</a>
        &nbsp;&nbsp;
        Up: <a class=navtable href="../examples/index.html" class="menu">Full examples</a>      </td>
    </tr>
  </table>
  </div>
</div>

<div class=sidebar>
  <a href="../ceres.html"><img src=../../images/Isis-Sothis-Demeter_sm.jpg
    width=90% border=0 alt='[Demeter logo]'></a>
  <br />
  <a href="../index.html"  class="menu">Home</a><br />
<a href="../intro.html"  class="menu">Introduction</a><br />
<a href="../data/index.html"  class="menu">Importing data</a><br />
<a href="../mue/index.html"  class="menu">Processing mu(E) data</a><br />
<a href="../xanes/index.html"  class="menu">Analysis of XANES data</a><br />
<a href="../highlevel/index.html"  class="menu">High level actions for Demeter objects</a><br />
<a href="../atoms/index.html"  class="menu">Atoms</a><br />
<a href="../feff/index.html"  class="menu">Feff</a><br />
<a href="../paths/index.html"  class="menu">Scattering paths</a><br />
<a href="../gds/index.html"  class="menu">Guess/Def/Set parameters</a><br />
<a href="../fit/index.html"  class="menu">Fitting EXAFS data</a><br />
<a href="../perl/index.html"  class="menu">Using perl to create a fitting model</a><br />
<a href="../lgcv.html"  class="menu">Local guess parameters and the characteristic value</a><br />
<a href="../pathlike/index.html"  class="menu">Path-like objects</a><br />
<a href="../su.html"  class="menu">Structural Units</a><br />
<a href="../ui.html"  class="menu">User interfaces</a><br />
<a href="../output.html"  class="menu">Output formats</a><br />
<a href="../examples/index.html"  class="menuselect">Full examples</a><br />
&nbsp;&#8618;&nbsp;<a href="../examples/methyltin.html"  class="menu">Methyltin chloride</a><br />
&nbsp;&#8618;&nbsp;<a href="../examples/agau.html"  class="menu">Silver/gold alloy</a><br />
&nbsp;&#8618;&nbsp;<a href="../examples/uranyl.html"  class="menu">Uranyl complex in solution</a><br />
&nbsp;&#8618;&nbsp;<span style="font-style: italic;">Histogram</span><br />
</div>

<div class=contentarea>


<h1>
  Histogram
</h1>
<h2>
  Fitting using an arbitrary distribution of atoms 
</h2>

<p>

In a simple fitting model, such as the fit to 
<a href="../fit/index.html">copper metal</a>,
we assume that the neighboring atoms are Gaussian distributed and that
all disorder about the near-neighbor scattering distance can be
described by the application of the &sigma;&sup2; term in the EXAFS
equation.  Often, this is quite enough.  For well-ordered materials,
it is probably even true.  For small levels of structural disorder,
the additional disorder thus introduced can often be approximated by
having a larger &sigma;&sup2; value or by introducing a small number of
additional scattering paths at slightly different distances.
</p>

<p>
Some systems, however, are not well described by a Gaussian
distribution.  When the structural disorder is sufficeintly large, a
simple Gaussian is inadequate to describe the distribution.  In the
EXAFS literature, higher cumulants are often used in this situation.
But even this approach is limited in that, in practice, one can only
measure small third and fourth cumulants (i.e. a skew and a kurtosis
of the distribution) with any precision.
</p>

<p>
In this example, I explain one method for incorporating the results of
a molecular dynamics simulation into an EXAFS analysis.  The system is
a very small metallic gold nanoparticle.  The very large ratio of
surface area to volume introduces substantial distortions to the local
structure of the particle.  These local structural distortions are
seen in the MD simulations.  From these MD simulations, we have  files
containing the local structure in the form of a histogram.  These
files contain some measure of the probability of finding a
neighboring atom on a grid of radial distances.  It looks something
like this:
</p>


<pre>  0.000  0.000000E+00
  .
    .
      .
  2.636  2.818836E-01
  2.642  3.801608E+00
  2.649  1.245984E+01
  2.656  1.017059E+00
  2.662  1.660477E-01
  2.668  6.903760E-02
  2.675  5.119136E-02
  2.681  6.556027E-02
  2.688  1.158219E-01
  .
    .
      . and so on out to about 6.5 A
</pre>

<table>
<tr>
<td>
<p>

Here is a plot of one calculated pair distribution function for these
metallic gold nanoparticles.  The main plot shows the distribution of
atoms in the first two coordination shells.  The bin populations have
been normalized such that the first coordination shell contains 12
atoms.  The inset shows a blow-up of the first coordination shell
along with a Gaussian fitted to that distribution.
</p>

</td>
<td width=640>
<a href="../../images/histogram.png" target=_blank><img border=0 src="../../images/histogram.png" alt="histogram.png" width=100%></a>
</td>
</tr>
</table>


<p>

From the inset to this figure, we see that a Gaussian is not a very
good representation of this distribution.  It does an ok job of
representing the bulk of the coordination shell, but it completely
fails to represent the smaller population of shorter Au-Au distances
which, presumably, result from truncation effects at the relatively
large surface.
</p>

<p>
The approach the <span class=program>DEMETER</span> offers is to compute an
<a href="../pathlike/sspath.html">SSPath</a>
at each bin of the histogram.  The  at each bin is set to the
population of that bin.  Each bin should get the same E&#8320;
parameter. If the histogram accurately represents all
soruces of disorder -- both structural and thermal, something that is
certainly possible in an MD simulation -- then no &sigma;&sup2; or 
&Delta;R parameters would be needed.  Of course, they could be
introduced to account for any shortcomings of the MD simulation
compared to the measured data.
</p>


<pre class=olscript>
<ol class=perlblock>
<li><span class="comment">#!/usr/bin/perl
<li></span><span class="keyword">use</span> <span class="word">Demeter</span> <span class="words">qw(:plotwith=gnuplot :ui=screen)</span><span class="structure">;</span>
<li>
<li><span class="comment">## -------- Import the results of a Feff calculation on bulk Au
<li></span><span class="keyword">my</span> <span class="symbol">$feff</span> <span class="operator">=</span> <span class="word">Demeter::Feff</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><span class="word">yaml</span><span class="operator">=&gt;</span><span class="single">'Au_feff.yaml'</span><span class="structure">);</span>
<li><span class="symbol">$feff</span><span class="operator">-&gt;</span><span class="word">set</span><span class="structure">(</span><span class="word">workspace</span><span class="operator">=&gt;</span><span class="double">&quot;./&quot;</span><span class="operator">,</span> <span class="word">screen</span><span class="operator">=&gt;</span><span class="number">0</span><span class="operator">,</span><span class="structure">);</span>
<li><span class="keyword">my</span> <span class="symbol">@list_of_paths</span> <span class="operator">=</span> <span class="cast">@</span><span class="structure">{</span> <span class="symbol">$feff</span><span class="operator">-&gt;</span><span class="word">pathlist</span> <span class="structure">};</span>
<li>
<li><span class="comment">## -------- Import some data
<li></span><span class="keyword">my</span> <span class="symbol">$data</span>&nbsp;&nbsp;<span class="operator">=</span> <span class="word">Demeter::Data::Prj</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><span class="word">file</span><span class="operator">=&gt;</span><span class="single">'Aunano.prj'</span><span class="structure">)</span> <span class="operator">-&gt;</span> <span class="word">record</span><span class="structure">(</span><span class="number">5</span><span class="structure">);</span>
<li><span class="symbol">$data</span> <span class="operator">-&gt;</span> <span class="word">set</span><span class="structure">(</span><span class="word">fft_kmin</span> <span class="operator">=&gt;</span> <span class="number">3</span><span class="operator">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">fft_kmax</span> <span class="operator">=&gt;</span> <span class="number">13</span><span class="operator">,</span>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">bft_rmin</span> <span class="operator">=&gt;</span> <span class="float">1.992</span><span class="operator">,</span>&nbsp;&nbsp;<span class="word">bft_rmax</span> <span class="operator">=&gt;</span> <span class="float">3.399</span><span class="operator">,</span>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">fit_k1</span>&nbsp;&nbsp;&nbsp;<span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">fit_k2</span>&nbsp;&nbsp;&nbsp;<span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">fit_k3</span><span class="operator">=&gt;</span><span class="number">1</span><span class="operator">,</span> <span class="structure">);</span>
<li>
<li><span class="comment">## -------- Import the first scattering path object and use it
<li>##&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to populate a histogram defined by an external file.
<li>##&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Also define a VPath containing the entire first
<li>##&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shell of the histogram.
<li></span><span class="keyword">my</span> <span class="symbol">$firstshell</span> <span class="operator">=</span> <span class="symbol">$list_of_paths</span><span class="structure">[</span><span class="number">1</span><span class="structure">];</span>
<li>
<li><span class="keyword">my</span> <span class="structure">(</span><span class="symbol">$rx</span><span class="operator">,</span> <span class="symbol">$ry</span><span class="structure">)</span> <span class="operator">=</span> <span class="symbol">$firstshell</span><span class="operator">-&gt;</span><span class="word">histogram_from_file</span><span class="structure">(</span><span class="single">'histogram_file'</span><span class="operator">,</span> <span class="number">1</span><span class="operator">,</span> <span class="number">2</span><span class="operator">,</span> <span class="float">2.5</span><span class="operator">,</span> <span class="float">3.1</span><span class="structure">);</span>
<li><span class="keyword">my</span> <span class="symbol">$common</span> <span class="operator">=</span> <span class="structure">[</span><span class="word">data</span><span class="operator">=&gt;</span><span class="symbol">$data</span><span class="operator">,</span> <span class="word">sigma2</span> <span class="operator">=&gt;</span> <span class="single">'sigsqr'</span><span class="operator">,</span> <span class="word">e0</span> <span class="operator">=&gt;</span> <span class="single">'enot'</span><span class="operator">,</span> <span class="word">delr</span> <span class="operator">=&gt;</span> <span class="single">'alpha*reff'</span><span class="structure">];</span>
<li>
<li><span class="keyword">my</span> <span class="symbol">$paths</span> <span class="operator">=</span> <span class="symbol">$firstshell</span> <span class="operator">-&gt;</span> <span class="word">make_histogram</span><span class="structure">(</span><span class="symbol">$rx</span><span class="operator">,</span> <span class="symbol">$ry</span><span class="operator">,</span> <span class="single">'amp'</span><span class="operator">,</span> <span class="literal">q{}</span><span class="operator">,</span> <span class="symbol">$common</span><span class="structure">);</span>
<li><span class="keyword">my</span> <span class="symbol">$vpath</span> <span class="operator">=</span> <span class="word">Demeter::VPath</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><span class="word">name</span><span class="operator">=&gt;</span><span class="single">'histo'</span><span class="structure">);</span>
<li><span class="symbol">$vpath</span><span class="operator">-&gt;</span><span class="word">include</span><span class="structure">(</span><span class="cast">@</span><span class="symbol">$paths</span><span class="structure">);</span>
<li>
<li><span class="comment">## -------- Some parameters
<li></span><span class="keyword">my</span> <span class="symbol">@gds</span> <span class="operator">=</span> <span class="structure">(</span>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">Demeter::GDS</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><span class="word">gds</span><span class="operator">=&gt;</span><span class="single">'guess'</span><span class="operator">,</span> <span class="word">name</span><span class="operator">=&gt;</span><span class="single">'amp'</span><span class="operator">,</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">mathexp</span><span class="operator">=&gt;</span><span class="number">6</span><span class="structure">)</span><span class="operator">,</span>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">Demeter::GDS</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><span class="word">gds</span><span class="operator">=&gt;</span><span class="single">'guess'</span><span class="operator">,</span> <span class="word">name</span><span class="operator">=&gt;</span><span class="single">'enot'</span><span class="operator">,</span>&nbsp;&nbsp;&nbsp;<span class="word">mathexp</span><span class="operator">=&gt;</span><span class="number">0</span><span class="structure">)</span><span class="operator">,</span>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">Demeter::GDS</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><span class="word">gds</span><span class="operator">=&gt;</span><span class="single">'set'</span><span class="operator">,</span>&nbsp;&nbsp;&nbsp;<span class="word">name</span><span class="operator">=&gt;</span><span class="single">'alpha'</span><span class="operator">,</span>&nbsp;&nbsp;<span class="word">mathexp</span><span class="operator">=&gt;</span><span class="number">0</span><span class="structure">)</span><span class="operator">,</span>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">Demeter::GDS</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><span class="word">gds</span><span class="operator">=&gt;</span><span class="single">'set'</span><span class="operator">,</span>&nbsp;&nbsp;&nbsp;<span class="word">name</span><span class="operator">=&gt;</span><span class="single">'sigsqr'</span><span class="operator">,</span> <span class="word">mathexp</span><span class="operator">=&gt;</span><span class="float">0.0</span><span class="structure">)</span><span class="operator">,</span>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">);</span>
<li><span class="symbol">$data</span><span class="operator">-&gt;</span><span class="word">po</span><span class="operator">-&gt;</span><span class="word">kweight</span><span class="structure">(</span><span class="number">2</span><span class="structure">);</span>
<li>
<li><span class="comment">## -------- Do the fit
<li></span><span class="keyword">my</span> <span class="symbol">$fit</span> <span class="operator">=</span> <span class="word">Demeter::Fit</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><span class="word">gds</span><span class="operator">=&gt;</span><span class="cast">\</span><span class="symbol">@gds</span><span class="operator">,</span> <span class="word">data</span><span class="operator">=&gt;</span><span class="structure">[</span><span class="symbol">$data</span><span class="structure">]</span><span class="operator">,</span> <span class="word">paths</span><span class="operator">=&gt;</span><span class="symbol">$paths</span><span class="structure">);</span>
<li><span class="symbol">$fit</span><span class="operator">-&gt;</span><span class="word">fit</span><span class="structure">;</span>
<li><span class="symbol">$fit</span><span class="operator">-&gt;</span><span class="word">interview</span><span class="structure">;</span>
</ol>
</pre>


<p>

At line 5-7 a <span class=program>FEFF</span> calculation on gold metal is imported.  This
calculation was made and frozen to the 
<span class=file>Au_feff.yaml</span> file ahead of time.
(See <a href="../feff/pathfinder.html">here</a> 
for details.)  We will only be using the first ScatteringPath object
from the path list.  That is the contribution from the first
coordination shell and will be used as the basis for the historgram.
</p>

<p>
At lines 10-13, data are imported from an <span class=program>ATHENA</span> project file.
At line 19, a reference to the ScatteringPath object for the first
coordination shell is stored in the <tt>$firstshell</tt>
variable.
</p>

<p>
All the interesting stuff in this example happens between lines 21 and
26.  First, the locations and populations of the histogram are read
from a column data file at line 21.  The 
<tt>histogram_from_file</tt> method (which is a
method of the ScatteringPath object) takes 5 arguments -- the file
name, the column numbers of the bin positions and bin populations, and
the range in R-space.  Bins in the histogram that lie outside the
R-range will not be considered.  An example of a histogram file is
shown above.  This method returns two scalars which are references to
the arrays containing the bin positions and populations, i.e. the x
and y arrays of the histogram.  To examine these arrays, you would
have to dereference these scalars:
</p>


<ol class=perlsample>
<br />
&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">@bin_positions</span> <span class="operator">=</span> <span class="cast">@</span><span class="symbol">$rx</span>
</ol>


<p>

At line 22, an anonymous array of path parameters values is created.
These values will be used for every Path object created by histogram
generating method.  Note that I am using this anonymous array to pass
various attributes to the Path objects in the histogram.  Passing
these in this way is just a convenience -- they could be set after the
fact instead.
</p>

<p>
At line 24, the set of Path objects representing the contribution from
each bin of the histogram is actually generated using the 
<tt>make_histogram</tt> method (also a method of
the ScatteringPath object).  This method takes 4 arguments.  The first
two are the array references returned by the
<tt>histogram_from_file</tt> method.  The last
argument is the array reference created at line 22.  Each item in the
array will be passed on to each of the Path objects that gets
generated. 
</p>

<p>
The third argument of the <tt>make_histogram</tt>
method is very important!  It is the name of the amplitude parameter
that will be varied in the fit. Each path parameter for every
generated path will be given a math expression that is this amplitude
parameter multiplied by the unit-normalized bin population.  Since the
histogram is unit normalized, this parameter represents the total
coordination number multiplied by the S&sup2;&#8320; value.
</p>

<p>
At lines 25 and 26, a 
<a href="../pathlike/vpath.html">VPath</a>
object is created to hold the contribution from the entire histogram.
This is particularly handy as a visualization tool if the histogram is
just one part of the fit. 
</p>

<p>
Finally a set of GDS object are defined and the fit is run.  Note that
an overall &sigma;&sup2; parameter has been defined but set to 0.  An
isotropic expansion parameter has also been defined but set to zero.
</p>


<table>
<tr>
<td>
<p>

Here is the result of the fit varying on S&sup2;&#8320; and E&#8320;.  The
&sigma;&sup2; parameter has been fixed to 0.  This fit isn't great, but
it is not horrible either.  It seems safe to say that the distribution
used here is not an adequate representation of the complete structural
and thermal disorder in this particular system.
</p>

</td>
<td width=640>
<a href="../../images/histo_fit_noss.png" target=_blank><img border=0 src="../../images/histo_fit_noss.png" alt="histo_fit_noss.png" width=100%></a>
</td>
</tr>
</table>

<table>
<tr>
<td>
<p>

In this fit, the  &sigma;&sup2; parameter has been set to be a guess
parameter.  It returns a non-zero value and substantially improves the
fit.  Whatever disorder was not considered in the input configuration
was accounted for to some extent by the addition of this parameter.
</p>

</td>
<td width=640>
<a href="../../images/histo_fit_withss.png" target=_blank><img border=0 src="../../images/histo_fit_withss.png" alt="histo_fit_withss.png" width=100%></a>
</td>
</tr>
</table>

<div class=figure style="max-width: 100%; min-width: 7em;">
<a name=histo_fit_wpaths>&nbsp;</a><br><a href=../../images/histo_fit_wpaths.png><img src="../../images/histo_fit_wpaths.png" width=49%></a>
&nbsp;&nbsp;<a href=../../images/histo_fit_wpaths_zoom.png><img src="../../images/histo_fit_wpaths_zoom.png" alt="foo" width=49%></a>
<br></a>
<p>
To fully understand how the histogram concept works, it is useful to
see the contribution from each bin in the histogram along with the
data and the fit.  (Left) The fit with &sigma;&sup2; floated showing
the contributions from each bin of the histogram.  Each individual bin
contributes only a small amount of the spectral weight, but together
they add up to the result.  (Right) Zooming in on the contributions
from each bin.  Note the complicated phase relationship of these paths
which contributes to the overall fit.
</p>
</div>

</div>

<br />
<hr class=hide />
<hr class=bottomdivider />

<div class=bottombar>
  <div class=copyright>
  <table>
    <tr>
      <td colspan=2>
        <span class=program>DEMETER</span> is copyright &copy; 2009-2014 Bruce Ravel
        &mdash;
        This document is copyright &copy; 2014 Bruce Ravel
        <br />
      </td>
    </tr>
    <tr valign=middle>
      <td> 
           <a href="http://creativecommons.org/licenses/by-sa/3.0/"><img src="../../images/somerights20.png" width="88" height="31" alt="" border="0" /></a> &nbsp;&nbsp;&nbsp;
      </td>
      <td>
  	This document is licensed under <a href="http://creativecommons.org/licenses/by-sa/3.0/">
  	The Creative Commons Attribution-ShareAlike License</a>.
  	<br />
  	If <span class=program>DEMETER</span> and this document are useful to you, please consider
  	<a href="http://creativecommons.org/support/">supporting The Creative Commons</a>.
      </td>
    </tr>
  </table>
</div>
</div>
  </body>
</html>