[% META title = 'Dispersive XAS'
        about = 'Calibrating data measured on a pixel detector'
        difficult = 1
%]

[% FILTER html_para -%]
In a dispersive XAS experiment a curved crystal polychromator replaces
the the standard monochromator.  By virtue of being curved, a
polychromator passes a much broader band of energies than a
monochromator.  The curved geometry means that different parts of the
crystal are at different angles relative to the incident white beam,
so each part of the crystal passes a different energy.  The curvature
also serves to focus the polychromatic beam to a spot at some distance
from the crystal.  The details of the band pass and the focal distance
depend on the energy range of the experiment.

The sample is placed at the focal spot.  All the energies pass through
and interact with the sample.  After the sample, the energies splay
out as the beam defocuses. The dispersive data is measured as a
function of pixel position on an areal detector.  Each pixel subtends
an energy range of the polychromatic beam.

[% PROCESS section label="The dispersive data processing algorithm" %]

These data must be calibrated by converting pixel position to energy.
This is done by measuring a well-known standard and the unknown data
in the identical experimental configuration.  The standard is compared
to the same sample as measured on a normal XAS beamline.  The
dispersive and standard data are compared.  Pixel position p is
converted to energy by a quadratic function:
[% END %]

[% WRAPPER math label="dispersive" -%]
E = A + B*p + C*p^2
[% END %]

[% FILTER html_para -%]
The parameters A, B, and C are determined by fitting the standard
measured in dispersive mode to the standard measured normally.  That
set of parameters is then applied to all the data measured under the
same experimental conditions.
[% END %]

[% WRAPPER figure file="dxas.png" %]
The dispersive XAS calibration dialog.
[% END %]

[% FILTER html_para -%]
In this example, taken from the
[% INCLUDE html/link text="demo file" link="../intro.html#gettinghelp" %]
for dispersive data calibration, data was measured on copper sulfide
along with a copper foil used as the standard.  The first item in the
group list is the data measured copper foil on a conventional
beamline.  The third item is the copper foil data measured in
dispersive mode.  The second item is that same measurement calibrated
by the beamline scientist and can be used to test [% athena %]'s
implementation.  The remaining data are a sequence of dispersive
measurements made on copper sulfide.  The conventionally measured data
is selected as the [% INCLUDE font/quote a="Standard" %] in the menu
at the top of the page in
[% INCLUDE imageref text="the figure above" label="dxas" %].

The fit using the equation above is quite sensitive to the starting
conditions.  It is therefore prudent to adjust the linear term by
hand.  The initial guess for the calibration terms is shown in red
along with the conventional data in blue in
[% INCLUDE imageref text="the plot below" label="dxas_initguess" %].
Changing the linear term to
0.29 and clicking the [% INCLUDE font/quote a="Reset offset" %] button
results in the green spectrum, which is much closer to the standard
data.
[% END %]

[% WRAPPER figure file="dxas_initguess.png" %]
The copper foil calibrated using the default parameters and a
reasonably close guess.
[% END %]

[% FILTER html_para -%]
The [% INCLUDE font/quote a="Reset offset" %] re-evaluates the offset
term to roughly align the first peak of the first derivative of the
standard with the peak of the dispersive spectrum calibrated with the
new linear term.  These two terms will stay strictly related as long
as the [% INCLUDE font/quote a="constrain offset to linear term" %]
button.  Once you have a linear term and offset that are close to
correct, unclick that button and try fitting by clicking the
[% INCLUDE font/quote a="Refine alignment parameters" %] button.

The resulting [% mu %] spectrum, shown
[% INCLUDE imageref text="below" label="dxas_fit" in=1 %],
looks very much like the conventional data.  For these data, the
dispersive [% chik %] spectrum is almost identical to the conventional
spectrum.  This gives some confidence in using the fitted conversion
parameters for the copper sulfide data.
[% END %]


[% WRAPPER figure file="dxas_fit.png" %]
The fit to the copper standard.
[% END %]


[% FILTER html_para -%]
Armed with these parameter values, we can convert the copper sulfide
data to energy.  A converted dispersive measurement can be made into a
data group and inserted into the group list by pressing the
[% INCLUDE font/quote a="Make data group" %] button.  The
[% INCLUDE font/quote a="Convert all MARKED pixel groups" %] button
will apply the conversion parameters to
[% INCLUDE html/link link="../ui/mark.html" text="all marked data groups" %].

Note that the algorithm employed by [% athena %] is a reimplementation
of an algorithm long used at ESRF beamline ID24.
[% END %]

[% PROCESS section label="Using the dispersive data correction" %]

[% FILTER html_para -%]
By default, the dispersive data correction tool is disabled in 
[% athena %].  The reason is that the test made on each imported data
file to determine whether it is contains dispersive data is rather
time consuming.  Since rather few of [% athena %]'s users measure
dispersive data, it is better to disable that time-consuming test.
Because it is disabled, you will see that the entry for 
[% INCLUDE font/quote a="Calibrate dispersive XAS" %] is greyed out in
the Data menu.

To enable the dispersive data correction, go to the 
[% INCLUDE html/link text="preferences dialog" link="../ui/prefs.html" %]
and set the [% INCLUDE preference group="Pixel" option="do_pixel_check" %]
parameter to true.  You will now be able to access the dispersive data
correction dialog.
[% END %]
